<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAZA Agriculture Fields & Micro Corridors</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5; }
        .header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; }
        .map-container { height: calc(100vh - 80px); position: relative; }
        #map { height: 100%; width: 100%; }
        .legend { position: absolute; bottom: 10px; left: 10px; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); z-index: 1000; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; }
        .legend-color { width: 20px; height: 20px; margin-right: 10px; border: 1px solid #ccc; }
        .status { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); z-index: 1000; }
    </style>
</head>
<body>
    <div class="header">
        <h1>KAZA Agriculture Fields & Micro Corridors</h1>
        <p>Green agriculture fields with red micro corridors and distance-based transparency</p>
    </div>

    <div class="map-container">
        <div id="map"></div>

        <div class="status" id="status">Loading agriculture data...</div>

        <div class="legend">
            <h4>Map Legend</h4>
            <div class="legend-item"><div class="legend-color" style="background-color: #28a745"></div><span>Agriculture Fields</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #dc3545"></div><span>Micro Corridors</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #dc3545; opacity: 0.8"></div><span>500m Buffer</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #dc3545; opacity: 0.6"></div><span>1000m Buffer</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #dc3545; opacity: 0.4"></div><span>2000m Buffer</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #dc3545; opacity: 0.2"></div><span>4000m Buffer</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #dc3545; opacity: 0.1"></div><span>6000m Buffer</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/shpjs@4.0.4/dist/shp.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([-18.5, 23.5], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Buffer distances in meters (user requested 500, 1000, 2000, 4000, 6000)
        const bufferDistances = [500, 1000, 2000, 4000, 6000];
        const bufferOpacities = [0.8, 0.6, 0.4, 0.2, 0.1]; // Decreasing transparency

        // Load agriculture fields first (green) - ACTUAL DATA
        const agriUrl = 'https://jonobenjamin.github.io/LUCIS-KAZA/Data/Agri_fields_converted.geojson';
        console.log('Loading agriculture GeoJSON from:', agriUrl);

        fetch(agriUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(agriGeojson => {
                console.log('Loaded agriculture fields:', agriGeojson.features.length, 'features');

                // Add agriculture fields in green
                const agriLayer = L.geoJSON(agriGeojson, {
                    style: {
                        color: '#28a745',
                        weight: 1,
                        opacity: 1,
                        fillColor: '#28a745',
                        fillOpacity: 0.7
                    },
                    onEachFeature: function(feature, layer) {
                        const area = turf.area(feature.geometry) / 10000; // Convert m² to hectares
                        layer.bindPopup(`<b>Agriculture Field</b><br>Area: ${area.toFixed(1)} hectares`);
                    }
                });

                agriLayer.addTo(map);
                console.log('Added agriculture fields to map');

                document.getElementById('status').textContent = 'Loading micro corridors...';

                // Load micro corridors with buffers - ACTUAL DATA
                const corridorsUrl = 'https://jonobenjamin.github.io/LUCIS-KAZA/Data/KAZA_micro_corridors_converted.geojson';
                console.log('Loading corridors GeoJSON from:', corridorsUrl);

                return fetch(corridorsUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(corridorsGeojson => {
                        console.log('Loaded micro corridors:', corridorsGeojson.features.length, 'features');

                        // Add solid micro corridors in red
                        const corridorsLayer = L.geoJSON(corridorsGeojson, {
                            style: {
                                color: '#dc3545',
                                weight: 3,
                                opacity: 1,
                                fillColor: '#dc3545',
                                fillOpacity: 1
                            },
                            onEachFeature: function(feature, layer) {
                                const length = feature.properties.length_km;
                                layer.bindPopup(`<b>Micro Corridor</b><br>Length: ${length} km`);
                            }
                        });

                        corridorsLayer.addTo(map);
                        console.log('Added micro corridors to map');

                        // Create distance buffers with decreasing transparency
                        createBuffers(corridorsGeojson);

                        // Fit map to show both layers
                        const allLayers = [agriLayer, corridorsLayer];
                        const group = new L.featureGroup(allLayers);
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });

                        document.getElementById('status').textContent = 'Map loaded successfully';
                    });
            })
            .catch(error => {
                console.error('Error loading agriculture or corridor data:', error);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            });

        // Create distance buffers with decreasing transparency
        function createBuffers(corridorsGeojson) {
            bufferDistances.forEach((distance, index) => {
                const opacity = bufferOpacities[index];

                // Create buffer around corridors
                const buffered = turf.buffer(corridorsGeojson, distance / 1000, {units: 'kilometers'});

                const bufferLayer = L.geoJSON(buffered, {
                    style: {
                        color: '#dc3545',
                        weight: 1,
                        opacity: opacity,
                        fillColor: '#dc3545',
                        fillOpacity: opacity
                    },
                    onEachFeature: function(feature, layer) {
                        layer.bindPopup(`
                            <b>Corridor Buffer</b><br>
                            <strong>Distance:</strong> ${distance}m<br>
                            <strong>Transparency:</strong> ${opacity}
                        `);
                    }
                });

                bufferLayer.addTo(map);
                console.log(`Added ${distance}m buffer with opacity ${opacity}`);
            });
        }

        console.log('Agriculture and corridors map initialized');
    </script>
</body>
</html>
