name: Sync KAZA Map to Frontend Repositories

on:
  push:
    branches:
      - main
    paths:
      - 'landuse_conflict.html'
      - 'Data/**'
  schedule:
    # Run daily at 7 AM UTC
    - cron: '0 7 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-kaza-map:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout KAZA repository (this repo)
        uses: actions/checkout@v3

      - name: Checkout personal frontend repository
        uses: actions/checkout@v3
        with:
          repository: jonobenjamin/ecoexist
          token: ${{ secrets.FRONTEND_REPO_TOKEN }}
          path: frontend-repo-personal

      - name: Checkout Ecoexist organization repository
        uses: actions/checkout@v3
        with:
          repository: Ecoexist/Elephant-Tracking
          token: ${{ secrets.ECOEXIST_ORG_TOKEN }}
          path: frontend-repo-ecoexist

      - name: Copy KAZA Map files to both repositories
        run: |
          echo "ðŸ“¦ Copying KAZA Map and Data to frontend repositories..."
          
          # Function to copy files to a repo
          copy_to_repo() {
            local repo_path=$1
            local repo_name=$2
            
            echo "ðŸ“¦ Copying KAZA Map to $repo_name..."
            
            # Create KAZA directory if it doesn't exist
            mkdir -p "$repo_path/kaza"
            
            # Copy unified KAZA map HTML file
            cp landuse_conflict.html "$repo_path/kaza/"
            
            # Copy the Data folder with all GeoJSON files
            echo "  ðŸ“‚ Copying Data folder..."
            mkdir -p "$repo_path/kaza/Data"
            
            # Copy all GeoJSON files (essential for the map)
            cp Data/*.geojson "$repo_path/kaza/Data/" 2>/dev/null || true
            
            # Copy shapefiles needed for LUCIS layer (loaded via shpjs)
            cp Data/LUCIS_KAZA.* "$repo_path/kaza/Data/" 2>/dev/null || true
            
            echo "âœ“ Copied to $repo_name"
          }
          
          # Copy to personal repo
          copy_to_repo "frontend-repo-personal" "jonobenjamin/ecoexist"
          
          # Copy to Ecoexist org repo
          copy_to_repo "frontend-repo-ecoexist" "Ecoexist/Elephant-Tracking"
          
          echo "âœ… All KAZA files copied to BOTH repositories!"
          
          # Create README for personal repo KAZA section
          cat > frontend-repo-personal/kaza/README.md << 'EOL'
          # ðŸ—ºï¸ KAZA Unified Map Viewer

          Interactive map viewer for KAZA (Kavango-Zambezi Transfrontier Conservation Area) data analysis.

          ## ðŸš€ View the Map

          Open `landuse_conflict.html` in a web browser or view it via GitHub Pages.

          ## ðŸ“Š Map Sections

          The unified map includes 6 interactive sections:

          1. **Agriculture Fields & Micro Corridors** - Agricultural areas with wildlife corridor sensitivity analysis
          2. **Urban Areas & Micro Corridors** - Urban development with corridor impact assessment
          3. **Suitability/Desirability Analysis** - Multi-criteria analysis layers (AG01, AG02, AG03, UG01, UG02)
          4. **Proximity Analysis** - Distance-based analysis for urban and agricultural areas
          5. **LUCIS Conflict Analysis** - Land use conflict identification and mapping
          6. **ArcGIS Online Dashboard** - Hosted dashboard with additional analytics

          ## ðŸ“ Data Sources

          The `Data/` folder contains:
          - **GeoJSON layers** - Vector data for boundaries, corridors, agriculture, urban areas
          - **Shapefile data** - LUCIS conflict analysis data
          - **Analysis outputs** - Suitability and proximity analysis results

          ### Key Layers:
          - `KAZA_Boundary.geojson` - KAZA TFCA boundary
          - `KAZA_corridors_sensitivity_wgs84.geojson` - Wildlife micro-corridors with sensitivity rankings
          - `Agri_fields_converted.geojson` - Agricultural field boundaries
          - `KAZA_urban_areas.geojson` - Urban area extents
          - `AG01-AG03_polygons.geojson` - Agricultural suitability analysis
          - `UG01-UG02_polygons.geojson` - Urban growth suitability analysis
          - `LUCIS_KAZA.*` - Land use conflict identification system data

          ## ðŸ”§ Technical Details

          - **Mapping Library:** Leaflet.js
          - **Data Format:** GeoJSON, Shapefiles
          - **Projection:** WGS84 (EPSG:4326)
          - **Base Map:** OpenStreetMap

          ## ðŸŒ About KAZA

          The Kavango-Zambezi Transfrontier Conservation Area (KAZA TFCA) is the world's largest terrestrial 
          transfrontier conservation area, spanning five countries in Southern Africa: Angola, Botswana, 
          Namibia, Zambia, and Zimbabwe.

          ## ðŸ“ž Contact

          **Ecoexist Trust**
          - Website: https://www.ecoexisttrust.org/
          - Email: gis@ecoexisttrust.org
          - Tel: +267 6865083

          ---

          *Last updated: Automatically via GitHub Actions from KAZA repository*
          *Data updated: $(date +'%Y-%m-%d')*
          EOL
          
          # Create README for Ecoexist organization repo KAZA section
          cat > frontend-repo-ecoexist/kaza/README.md << 'EOL'
          # ðŸ—ºï¸ KAZA Unified Map Viewer

          **Official KAZA analysis dashboard for Ecoexist Trust**

          Interactive map viewer for KAZA (Kavango-Zambezi Transfrontier Conservation Area) spatial analysis.

          ## ðŸš€ View the Map

          Open `landuse_conflict.html` in a web browser or access via GitHub Pages:
          `https://ecoexist.github.io/Elephant-Tracking/kaza/landuse_conflict.html`

          ## ðŸ“Š Map Sections

          The unified map includes 6 interactive sections:

          1. **Agriculture Fields & Micro Corridors** - Agricultural areas with wildlife corridor sensitivity analysis
          2. **Urban Areas & Micro Corridors** - Urban development with corridor impact assessment
          3. **Suitability/Desirability Analysis** - Multi-criteria analysis layers (AG01, AG02, AG03, UG01, UG02)
          4. **Proximity Analysis** - Distance-based analysis for urban and agricultural areas
          5. **LUCIS Conflict Analysis** - Land use conflict identification and mapping
          6. **ArcGIS Online Dashboard** - Hosted dashboard with additional analytics

          ## ðŸ“ Data Layers

          - Wildlife micro-corridors with sensitivity rankings
          - Agricultural field boundaries and suitability
          - Urban area extents and growth analysis
          - KAZA TFCA boundary
          - Land use conflict zones
          - Proximity and accessibility analysis

          ## ðŸŽ¯ Purpose

          This tool supports:
          - Wildlife conservation planning
          - Land use conflict resolution
          - Development impact assessment
          - Stakeholder engagement and communication
          - Evidence-based policy recommendations

          ## ðŸŒ About KAZA TFCA

          The Kavango-Zambezi Transfrontier Conservation Area is the world's largest terrestrial 
          transfrontier conservation area, spanning Angola, Botswana, Namibia, Zambia, and Zimbabwe.

          ## ðŸ“ž Contact

          **Ecoexist Trust**
          - Website: https://www.ecoexisttrust.org/
          - Email: info@ecoexisttrust.org | gis@ecoexisttrust.org
          - Tel: +267 6865083

          ---

          *This repository is automatically updated from our KAZA analysis system.*
          *For technical inquiries, contact: gis@ecoexisttrust.org*
          EOL
          
          echo "âœ“ Created README files for KAZA sections"

      - name: Commit and push to personal repository
        run: |
          cd frontend-repo-personal
          
          git config user.name "Ecoexist Bot"
          git config user.email "bot@ecoexisttrust.org"
          
          git add kaza/
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit to personal repo"
          else
            git commit -m "ðŸ—ºï¸ Auto-update: KAZA Map - $(date +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… Pushed KAZA map to jonobenjamin/ecoexist"
          fi

      - name: Commit and push to Ecoexist organization repository
        run: |
          cd frontend-repo-ecoexist
          
          git config user.name "Ecoexist Bot"
          git config user.email "bot@ecoexisttrust.org"
          
          git add kaza/
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit to Ecoexist org repo"
          else
            git commit -m "ðŸ—ºï¸ Auto-update: KAZA Map - $(date +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… Pushed KAZA map to Ecoexist/Elephant-Tracking"
          fi

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… KAZA Map Sync Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“¦ Files synced:"
          echo "  â€¢ unified_kaza_map.html"
          echo "  â€¢ Data/ folder (GeoJSON + shapefiles)"
          echo ""
          echo "ðŸŒ Repositories updated:"
          echo "  â€¢ jonobenjamin/ecoexist"
          echo "  â€¢ Ecoexist/Elephant-Tracking"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
